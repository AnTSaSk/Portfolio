services:
  app:
    image: ghcr.io/${GITHUB_REPOSITORY}:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      NUXT_BASE_URL: https://${APP_DOMAIN:-alexisbesson.fr}
    networks:
      - traefik-public
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 384M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"
      labels:
        # Traefik routing
        - "traefik.enable=true"
        - "traefik.http.routers.${APP_NAME:-portfolio}.rule=Host(`${APP_DOMAIN:-alexisbesson.fr}`)"
        - "traefik.http.routers.${APP_NAME:-portfolio}.entrypoints=websecure"
        - "traefik.http.routers.${APP_NAME:-portfolio}.tls.certresolver=letsencrypt"
        - "traefik.http.services.${APP_NAME:-portfolio}.loadbalancer.server.port=3000"
        # Health check
        - "traefik.http.services.${APP_NAME:-portfolio}.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.${APP_NAME:-portfolio}.loadbalancer.healthcheck.interval=30s"

        # Apply middlewares: custom security headers + rate limiting
        # IMPORTANT: Custom middleware WITHOUT X-Robots-Tag to allow SEO indexing
        # The global security-headers middleware includes X-Robots-Tag: noindex
        # which would block search engines from indexing this public portfolio
        - "traefik.http.routers.${APP_NAME:-portfolio}.middlewares=compress,${APP_NAME:-portfolio}-security,${APP_NAME:-portfolio}-ratelimit"

        # Middleware: Security headers (NO X-Robots-Tag â€” allows SEO indexing)
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.stsSeconds=63072000"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.frameDeny=true"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.browserXssFilter=true"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.referrerPolicy=strict-origin-when-cross-origin"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.permissionsPolicy=accelerometer=(), ambient-light-sensor=(), autoplay=(), camera=(), document-domain=(), encrypted-media=(), fullscreen=(self), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), usb=()"
        # CSP adapted for Nuxt 3 SSR (unsafe-inline required for Vue hydration styles)
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-security.headers.contentSecurityPolicy=default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; form-action 'self'; base-uri 'self'"

        # Middleware: Rate limiting
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-ratelimit.ratelimit.average=100"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-ratelimit.ratelimit.burst=50"
        - "traefik.http.middlewares.${APP_NAME:-portfolio}-ratelimit.ratelimit.period=1s"

    # Security hardening - maximum isolation
    # NOTE: no-new-privileges is enforced at Docker daemon level (daemon.json)
    # security_opt is ignored by 'docker stack deploy' in Swarm mode
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64m
      - /app/.output/server/.data:mode=1777,size=32m
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  traefik-public:
    external: true
